sudo: required

language: go
go:
    - "1.11"

services:
    - docker

env:
    - GO111MODULE=on

before_install:
    - curl https://sh.rustup.rs -sSf | sh -s -- -y
    - export PATH=~/.cargo/bin:$PATH
    - mkdir tmp
    - git clone https://github.com/macarrie/vidocq tmp/vidocq
    - pushd tmp/vidocq && cargo build --release && popd
    - export PATH=$PATH:$PWD/tmp/vidocq/target/release/

jobs:
    include:
        - stage: test
          script: make test

        - stage: build
          script: make build

        - stage: docker
          script: make build docker
          deploy:
              - provider: script
                script: bash -c "echo \"$DOCKER_PASSWORD\" | docker login -u \"$DOCKER_USERNAME\" --password-stdin; docker push macarrie/flemzerd"
                on:
                    branch: master
              - provider: script
                script: bash -c "echo \"$DOCKER_PASSWORD\" | docker login -u \"$DOCKER_USERNAME\" --password-stdin; docker tag macarrie/flemzerd macarrie/flemzer:$TRAVIS_TAG && docker push macarrie/flemzerd"
                on:
                    tags: true
                    branch: master

after_success:
    - bash <(curl -s https://codecov.io/bash)
