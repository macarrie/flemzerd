sudo: required

language: go
go:
    - "1.11"

services:
    - docker

env:
    - GO111MODULE=on

jobs:
    include:
        - stage: test
          script: 
          - make tmp/vidocq/vidocq
          - sudo cp tmp/vidocq/vidocq /usr/bin
          - sudo chmod a+x /usr/bin/vidocq
          - make test

        - stage: build
          script: make build

        - stage: docker
          script: make build docker
          deploy:
              - provider: script
                script: bash -c "echo \"$DOCKER_PASSWORD\" | docker login -u \"$DOCKER_USERNAME\" --password-stdin; docker push macarrie/flemzerd"
                on:
                    branch: master
              - provider: script
                script: bash -c "echo \"$DOCKER_PASSWORD\" | docker login -u \"$DOCKER_USERNAME\" --password-stdin; docker tag macarrie/flemzerd macarrie/flemzer:$TRAVIS_TAG && docker push macarrie/flemzerd"
                on:
                    tags: true
                    branch: master

after_success:
    - bash <(curl -s https://codecov.io/bash)
